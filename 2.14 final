%%  part 4
clear all
s = tf('s');

load 'GpPlantFrequencyData';  % loads the experimental data on the 
G = 0.002154;
k = 12698;
w = 926.8;
m = k/w^2;
b = sqrt(1/G^2 -(k-m*w^2)^2)/w;
Gp = tf(1,[m b k]);
[~,~,wout_old] =bode(Gp);
w = vertcat(wout_old,transpose(10^4:10^4:10^5));
[mag,~,wout] =bode(Gp,w);

subplot(2,1,1)
loglog(ww,Gpmag,squeeze(wout),squeeze(mag))

subplot(2,1,2)
semilogx(ww,Gpphase)
%% fit high freq 
wz1 = 6.001e+4;
wp1 = 7.985e+4;
wz2 = 1.305e+5;
wp2 = 1.608e+5;
wp3 = 2.108e+5;
wz3 = 2.297e+5;

wz = [wz1 wz2 wz3];
wp = [wp1 wp2 wp3];

magz =[2.35e-9, 1.464e-9,4.86e-10];
magp =[1.153e-7,6.734e-8,4.575e-8 ];

bz = [0.035,0.03,0.0094];%bz = [0.0625,0.0826,0.0094];%bz = zeros(1,3);
bp = [0.025,0.0219,0.01]%bp = [0.0363,0.0219,0.01];%bp = zeros(1,3);

Gp_new = ss(Gp); % state space of Gp and updates every loop
for i=1:2%i =1:2?
    [mag,~,~] = bode(Gp_new,wz(i));  %find magnitude
    %bz(i) = (magz(i)/squeeze(mag))/2; %damping
    %Gp_new = Gp_new*tf([1 2*bz*wz(i) wz(i)^2])/wz(i)^2; % gives error
    add = ss(tf([1 2*bz(i)*wz(i) wz(i)^2],[wz(i)^2]));
    Gp_new = series(Gp_new,add);
    
    [mag,~,~] = bode(Gp_new,wp(i));
    %bp(i) = squeeze(mag)/(magp(i)*2);
    add = ss(tf([wp(i)^2],[1 2*bp(i)*wp(i) wp(i)^2]));
    Gp_new = series(Gp_new,add);

end
 
    [mag,~,~] = bode(Gp_new,wp(3));
    %bp = squeeze(mag)/(magp(3)*2);% 0.0715
    %bp(3) = 0.01;
    add = ss(tf([wp(3)^2],[1 2*bp(3)*wp(3) wp(3)^2])); 
    Gp_new = series(Gp_new,add);
    
    [mag,~,~] = bode(Gp_new,wz(3));  %find magnitude
    %bz(3) = (magz(3)/squeeze(mag))/2; %damping
    add = ss(tf([1 2*bz(3)*wz(3) wz(3)^2],[wz(3)^2]));
    Gp_new = series(Gp_new,add);
    
% add delay
T = 1.5e-5 ;
delay = ss(tf(exp(-s*T)));
Gp_new = series(Gp_new, delay);
    
%% plots overlaid Gp_new and Gp 
[mag,phase,wout] =bode(Gp_new);
subplot(2,1,1)
loglog(ww,Gpmag,squeeze(wout),squeeze(mag))

subplot(2,1,2)
semilogx(ww,Gpphase,squeeze(wout),squeeze(phase))

